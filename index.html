<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1e40af;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --danger-light: #f87171;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --bg-secondary: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius-sm: 6px;
            --radius: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding: 2rem 2rem 6rem;
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        .header .developer {
            font-size: 0.9rem;
            opacity: 0.85;
            margin-top: 0.5rem;
            position: relative;
            z-index: 1;
            font-weight: 400;
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--border-light);
            overflow-x: auto;
            position: relative;
        }

        .tabs::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: var(--primary);
            width: 0;
            transition: var(--transition);
        }

        .tab {
            padding: 1.25rem 2rem;
            cursor: pointer;
            border: none;
            background: transparent;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            opacity: 0;
            transition: var(--transition);
        }

        .tab:hover::before {
            opacity: 1;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
            background: linear-gradient(to bottom, rgba(37, 99, 235, 0.05) 0%, transparent 100%);
        }

        .tab.active::before {
            opacity: 0;
        }

        .content {
            padding: 2.5rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 2.5rem;
        }

        .section-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--border-light);
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 3px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-size: 0.95rem;
            display: block;
        }

        .form-control {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition);
            background: white;
            width: 100%;
        }

        .form-control:hover {
            border-color: var(--primary-light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }

        .form-control::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .items-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .items-table th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
            border: none;
        }

        .items-table td {
            padding: 0.875rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .items-table tbody tr {
            transition: var(--transition);
        }

        .items-table tbody tr:hover {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.03) 0%, transparent 100%);
        }

        .items-table tbody tr:last-child td {
            border-bottom: none;
        }

        .items-table input {
            width: 100%;
            padding: 0.625rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-family: 'Sarabun', sans-serif;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .items-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .items-table input:hover {
            border-color: var(--primary-light);
        }

        .items-table tfoot {
            background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
            font-weight: 700;
        }

        .items-table tfoot td {
            font-size: 1rem;
            padding: 1rem 0.75rem;
            color: var(--primary);
            border: none;
        }

        .items-table .number-col {
            width: 60px;
            text-align: center;
        }

        .items-table .item-col {
            min-width: 300px;
        }

        .items-table .price-col,
        .items-table .qty-col,
        .items-table .unit-col {
            width: 120px;
        }

        .items-table .total-col {
            width: 120px;
            text-align: right;
        }

        .items-table .action-col {
            width: 60px;
            text-align: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: white;
        }

        .btn-success:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--accent-light) 100%);
            color: white;
        }

        .btn-warning:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: white;
        }

        .btn-danger:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤ */
        .btn-price-db {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            animation: pulse 2s ease-in-out infinite;
        }

        .btn-price-db::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-price-db:hover::after {
            width: 300px;
            height: 300px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .btn-price-db:hover {
            animation: none;
            transform: translateY(-3px) scale(1.05);
        }

        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border-light);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.75rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--bg) 0%, white 100%);
        }

        .modal-header h3 {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--primary);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--bg);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            background: white;
        }

        /* History Card */
        .history-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 1.75rem;
            margin-bottom: 1.25rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .history-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.03) 0%, transparent 100%);
            opacity: 0;
            transition: var(--transition);
        }

        .history-card:hover::before {
            opacity: 1;
        }

        .history-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-left-width: 6px;
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .history-card-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .history-card-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-card-meta::before {
            content: 'üìÖ';
            font-size: 0.9rem;
        }

        .history-card-badge {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: var(--shadow-sm);
            letter-spacing: 0.3px;
        }

        .history-card-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            font-size: 0.9rem;
            margin-bottom: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .history-card-info > div {
            padding: 0.5rem 0;
        }

        .history-card-info strong {
            color: var(--text);
            font-weight: 600;
        }

        .history-card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .special-note-display {
            margin-top: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius);
            font-size: 0.875rem;
            color: var(--primary-dark);
            line-height: 1.6;
            box-shadow: var(--shadow-sm);
        }

        .special-note-display::before {
            content: 'üìù ‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©: ';
            font-weight: 700;
            color: var(--primary);
        }

        .tip-box {
            padding: 1rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning);
            border-radius: var(--radius);
            margin-top: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .tip-box p {
            margin: 0;
            font-size: 0.875rem;
            color: #92400e;
            line-height: 1.6;
        }

        .tip-box strong {
            color: #78350f;
            font-weight: 700;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 1.75rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
        }

        .filter-section h4 {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1.25rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Print Document Styles */
        .print-document {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            font-family: 'Sarabun', sans-serif;
            color: black;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .print-document .doc-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .print-document .doc-header-right {
            text-align: right;
            margin-bottom: 10px;
        }

        .print-document .doc-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .print-document .doc-subtitle {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .print-document .doc-date {
            font-size: 14px;
            text-align: right;
            margin-bottom: 10px;
            padding-right: 20px;
        }

        .print-document .doc-content {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .print-document .doc-content p {
            margin-bottom: 5px;
        }

        .print-document .special-note {
            font-size: 12px;
            color: #0066cc;
            font-style: italic;
            margin: 5px 0;
        }

        .print-document table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }

        .print-document table th,
        .print-document table td {
            border: 1px solid #333;
            padding: 5px 3px;
            text-align: center;
        }

        .print-document table th {
            background: #f0f0f0;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .print-document table td.number {
            text-align: center;
            width: 35px;
        }

        .print-document table td.amount {
            text-align: center;
            padding-right: 5px;
        }

        .print-document table tfoot td {
            font-weight: 600;
            background: #f0f0f0;
            font-size: 14px;
        }

        .print-document .signature-section {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            font-size: 14px;
        }

        .print-document .signature-box {
            text-align: center;
        }

        .print-document .signature-box img {
            max-width: 150px;
            max-height: 60px;
            margin: 5px auto;
            display: block;
        }

        .print-document .signature-line {
            margin-top: 40px;
            margin-bottom: 5px;
        }

        .print-document .note {
            margin-top: 15px;
            font-size: 14px;
        }

        #printArea {
            display: none;
        }

        /* Checkbox for merge */
        .merge-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .merge-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .merge-checkbox-item {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
            transition: var(--transition);
        }

        .merge-checkbox-item:hover {
            transform: scale(1.1);
        }

        /* Admin Panel Styles */
        .admin-card {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .admin-card:hover {
            box-shadow: var(--shadow-md);
        }

        .admin-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .file-input-label input[type="file"] {
            display: none;
        }

        .price-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .price-history-table th,
        .price-history-table td {
            padding: 0.875rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .price-history-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 700;
            border: none;
        }

        .price-history-table tbody tr {
            transition: var(--transition);
        }

        .price-history-table tbody tr:hover {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.03) 0%, transparent 100%);
        }

        .price-history-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Search box highlight */
        #priceDbSearch {
            transition: all 0.3s ease;
        }

        #priceDbSearch:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
            transform: scale(1.02);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            transition: var(--transition);
            border-radius: 34px;
            box-shadow: var(--shadow-sm);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        input:disabled + .slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Signature Preview */
        .signature-preview {
            margin-top: 1rem;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: 8px;
            text-align: center;
        }

        .signature-preview img {
            max-width: 300px;
            max-height: 150px;
            margin: 0.5rem auto;
            display: block;
        }

        .signature-preview-empty {
            color: #718096;
            font-style: italic;
        }

        /* Icon buttons for price database */
        .btn-icon-small {
            padding: 0.4rem;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .btn-icon-small:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-icon-edit {
            background: #d69e2e;
            color: white;
        }

        .btn-icon-delete {
            background: #e53e3e;
            color: white;
        }

        @media print {
            body > *:not(#printArea) {
                display: none !important;
            }

            #printArea {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .print-document {
                box-shadow: none !important;
                page-break-after: always;
            }

            @page {
                size: A4 portrait;
                margin: 10mm;
            }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1.25rem 1.75rem;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 2000;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast::before {
            content: '‚úì';
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            font-weight: 700;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
        }

        .toast.error::before {
            content: '‚úï';
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
            background: white;
            padding: 2rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-xl);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem 0.5rem 5rem;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .content {
                padding: 1rem;
            }

            .form-grid, .filter-grid {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .tabs {
                overflow-x: scroll;
            }

            .history-card {
                padding: 1.25rem;
            }

            .history-card-header {
                flex-direction: column;
                gap: 1rem;
            }

            .history-card-badge {
                align-self: flex-start;
            }

            .modal-content {
                max-width: 100%;
                max-height: 95vh;
            }

            .toast {
                right: 1rem;
                bottom: 1rem;
                left: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h1>
            <p>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
            <p class="developer">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            <button class="tab" onclick="switchTab('history')">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            <button class="tab" onclick="switchTab('admin')">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
        </div>

        <div class="content">
            <!-- Tab: Create Document -->
            <div id="createTab" class="tab-content active">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div class="section-title">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
                        <span id="autoSaveIndicator" style="font-size: 0.875rem; opacity: 0; transition: all 0.3s ease; color: var(--success); font-weight: 600; padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius); display: inline-flex; align-items: center; gap: 0.5rem;"></span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span style="color: red;">*</span></label>
                            <input type="text" class="form-control" id="semester" required 
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô 1/2569">
                        </div>
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ <span style="color: red;">*</span></label>
                            <input type="text" class="form-control" id="projectName" required 
                                   value="‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏∑‡πà‡∏≠ ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢"
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏∑‡πà‡∏≠ ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢">
                        </div>
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                            <input type="text" class="form-control" id="director" 
                                   value="‡∏ô‡∏≤‡∏á‡∏™‡∏∏‡∏ô‡∏¥‡∏™‡∏≤ ‡πÉ‡∏à‡πÉ‡∏´‡∏ç‡πà">
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏™‡∏î‡∏∏</label>
                            <input type="text" class="form-control" id="officer" 
                                   value="‡∏ô‡∏≤‡∏¢‡πÑ‡∏Å‡∏£‡∏™‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏ß‡∏µ">
                        </div>
                        <div class="form-group">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ <span style="color: red;">*</span></label>
                            <select class="form-control" id="docType" required>
                                <option value="‡∏ã‡∏∑‡πâ‡∏≠">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</option>
                                <option value="‡∏à‡πâ‡∏≤‡∏á">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <span style="color: red;">*</span></label>
                            <input type="text" class="form-control" id="creatorName" required 
                                   placeholder="‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏ô‡∏ô‡∏ó‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏´‡∏¥‡∏£‡∏±‡∏ç‡πÄ‡∏£‡∏∑‡∏≠‡∏á">
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <span style="color: red;">*</span></label>
                            <input type="tel" class="form-control" id="phoneNumber" required 
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678">
                        </div>
                        <div class="form-group">
                            <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ <span style="color: red;">*</span></label>
                            <select class="form-control" id="department" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞ --</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
                                <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-small" onclick="addRow()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
                        </button>
                        <button class="btn btn-warning btn-small" onclick="clearTable()">
                            üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        </button>
                        <button class="btn btn-success btn-small btn-price-db" onclick="showPriceDatabase()">
                            üí∞ ‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="items-table" id="itemsTable">
                            <thead>
                                <tr>
                                    <th class="number-col">‡∏ó‡∏µ‡πà</th>
                                    <th class="item-col">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="price-col">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                                    <th class="qty-col">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th class="unit-col">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                                    <th class="total-col">‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                    <th class="action-col">‡∏•‡∏ö</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Rows will be added here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" style="text-align: right;">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td>
                                    <td id="grandTotal" style="text-align: right;">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="saveData()">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                    <button class="btn btn-primary" onclick="previewDocument('detail')">
                        üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                    <button class="btn btn-primary" onclick="previewDocument('order')">
                        üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏à‡πâ‡∏≤‡∏á
                    </button>
                    <button class="btn btn-warning" onclick="confirmClearDraft()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Draft
                    </button>
                </div>
            </div>

            <!-- Tab: History -->
            <div id="historyTab" class="tab-content">
                <div class="section">
                    <div class="section-title">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏à‡πâ‡∏≤‡∏á</div>
                    
                    <div class="filter-section">
                        <h4 style="margin-bottom: 1rem;">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                        <div class="filter-grid">
                            <div class="form-group">
                                <label>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                                <select class="form-control" id="filterSemester" onchange="filterHistory()">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</label>
                                <select class="form-control" id="filterDepartment" onchange="filterHistory()">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
                                    <option value="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                                <select class="form-control" id="filterDocType" onchange="filterHistory()">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="‡∏ã‡∏∑‡πâ‡∏≠">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</option>
                                    <option value="‡∏à‡πâ‡∏≤‡∏á">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-small" onclick="printMergedDocuments('detail')">
                                üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤)
                            </button>
                            <button class="btn btn-primary btn-small" onclick="printMergedDocuments('order')">
                                üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏à‡πâ‡∏≤‡∏á (‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤)
                            </button>
                            <button class="btn btn-success btn-small" onclick="printMergedSingleTable('detail')">
                                üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                            </button>
                            <button class="btn btn-success btn-small" onclick="printMergedSingleTable('order')">
                                üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏à‡πâ‡∏≤‡∏á (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                            </button>
                        </div>
                        <div class="tip-box">
                            <p>
                                üí° <strong>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å<strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</strong>
                            </p>
                        </div>
                    </div>

                    <div id="historyList">
                        <!-- History cards will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Admin -->
            <div id="adminTab" class="tab-content">
                <div class="section">
                    <div class="section-title">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>

                    <!-- Digital Signature Management -->
                    <div class="admin-card">
                        <h3>‚úçÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</h3>
                        <p style="margin-bottom: 1rem; color: #718096;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û PNG) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏à‡πâ‡∏≤‡∏á</p>
                        
                        <!-- Enable/Disable Digital Signature -->
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="digitalSignatureToggle" onchange="toggleDigitalSignature()">
                                <span class="slider"></span>
                            </label>
                            <span id="digitalSignatureStatus">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        </div>

                        <div id="digitalSignatureInputs" style="display: none;">
                            <!-- Director Signature -->
                            <div style="margin-bottom: 2rem;">
                                <h4 style="margin-bottom: 0.5rem;">üìù ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</h4>
                                <label class="file-input-label">
                                    üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (PNG)
                                    <input type="file" accept="image/png" onchange="uploadSignature(event, 'director')">
                                </label>
                                <div class="signature-preview" id="directorSignaturePreview">
                                    <div class="signature-preview-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteSignature('director')" style="margin-top: 0.5rem;">
                                    üóëÔ∏è ‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                                </button>
                            </div>

                            <!-- Officer Signature -->
                            <div style="margin-bottom: 1rem;">
                                <h4 style="margin-bottom: 0.5rem;">üìù ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏™‡∏î‡∏∏</h4>
                                <label class="file-input-label">
                                    üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (PNG)
                                    <input type="file" accept="image/png" onchange="uploadSignature(event, 'officer')">
                                </label>
                                <div class="signature-preview" id="officerSignaturePreview">
                                    <div class="signature-preview-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteSignature('officer')" style="margin-top: 0.5rem;">
                                    üóëÔ∏è ‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Data -->
                    <div class="admin-card">
                        <h3>üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                        <p style="margin-bottom: 1rem; color: #718096;">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel</p>
                        <button class="btn btn-success" onclick="exportAllData()">
                            üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô Excel
                        </button>
                    </div>

                    <!-- Import Price Database -->
                    <div class="admin-card">
                        <h3>üì• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <p style="margin-bottom: 1rem; color: #718096;">
                            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label class="file-input-label">
                                üìÅ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel
                                <input type="file" accept=".xlsx,.xls" onchange="importPriceDatabase(event)">
                            </label>
                            <button class="btn btn-success" onclick="showPriceDatabase()">
                                üí∞ ‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤
                            </button>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: #718096;">
                            ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 1 = ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 2 = ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 3 = ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö
                        </p>
                    </div>

                    <!-- Special Note Toggle -->
                    <div class="admin-card">
                        <h3>üìù ‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
                        <p style="margin-bottom: 1rem; color: #718096;">
                            ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß<br>
                            ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <strong>üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</strong><br>
                            ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° <strong>üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï</strong> ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                        </p>
                        <div style="padding: 1rem; background: #f7fafc; border-left: 3px solid var(--primary); border-radius: 4px;">
                            <p style="margin: 0; font-size: 0.9rem;"><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong></p>
                            <ol style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem; line-height: 1.8;">
                                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï</li>
                                <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï"</li>
                                <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á template ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</li>
                                <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</li>
                            </ol>
                        </div>
                        
                        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ -->
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e2e8f0; opacity: 0.5;">
                            <p style="font-size: 0.85rem; color: #718096; font-style: italic;">
                                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö global ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                            </p>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="specialNoteToggle" onchange="toggleSpecialNote()" disabled>
                                    <span class="slider"></span>
                                </label>
                                <span id="specialNoteStatus">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                            </div>
                        </div>
                    </div>

                    <!-- Price History -->
                    <div class="admin-card">
                        <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <p style="margin-bottom: 1rem; color: #718096;">‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                        <button class="btn btn-primary" onclick="showPriceHistory()">
                            üìä ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">üìÑ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
                <button class="modal-close" onclick="closeModal('previewModal')">&times;</button>
            </div>
            <div class="modal-body" id="previewArea">
                <!-- Document preview will be rendered here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('previewModal')">‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-success" onclick="printDocument()">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            </div>
        </div>
    </div>

    <!-- Price Database Modal -->
    <div class="modal-overlay" id="priceDbModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button class="modal-close" onclick="closeModal('priceDbModal')">&times;</button>
            </div>
            <div class="modal-body" style="background: white; padding: 1.5rem;">
                <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <input type="text" id="priceDbSearch" class="form-control" 
                           placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." 
                           oninput="filterPriceDatabase()"
                           style="max-width: 400px;">
                    <button class="btn btn-success btn-small" onclick="addNewPriceItem()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                <div id="priceDbContent">
                    <!-- Price database will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('priceDbModal')">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Price History Modal -->
    <div class="modal-overlay" id="priceHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button class="modal-close" onclick="closeModal('priceHistoryModal')">&times;</button>
            </div>
            <div class="modal-body" id="priceHistoryArea">
                <!-- Price history will be rendered here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('priceHistoryModal')">‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-success" onclick="printPriceHistory()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤</button>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal-overlay" id="editItemModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="editItemModalTitle">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <button class="modal-close" onclick="closeModal('editItemModal')">&times;</button>
            </div>
            <div class="modal-body" style="background: white; padding: 2rem;">
                <input type="hidden" id="editItemKey">
                <div class="form-group">
                    <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="editItemName" required>
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) <span style="color: red;">*</span></label>
                    <input type="number" class="form-control" id="editItemPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö <span style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="editItemUnit" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('editItemModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-success" onclick="saveEditedItem()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="printArea">
        <!-- Document for printing will be rendered here -->
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAdOpDSLDJxzIR6l9g63nsZvzutTE2juV4",
            authDomain: "bisungsue2569.firebaseapp.com",
            projectId: "bisungsue2569",
            storageBucket: "bisungsue2569.firebasestorage.app",
            messagingSenderId: "361000559438",
            appId: "1:361000559438:web:31195f3bb6b85513d2b41f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firestore = { collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, setDoc };

        console.log('Firebase initialized successfully!');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
        let firebaseReady = false;

        // Load initial data
        window.addEventListener('DOMContentLoaded', async () => {
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            let attempts = 0;
            while (!window.db && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (window.db && window.firestore) {
                firebaseReady = true;
                console.log('‚úÖ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            } else {
                firebaseReady = false;
                console.error('‚ùå Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                
                Swal.fire({
                    title: '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!',
                    html: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase ‡πÑ‡∏î‡πâ<br>‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
            }

            await loadAdminSettings();
            
            // Load form from localStorage first
            loadFormFromLocalStorage();
            
            // If no saved data, initialize empty rows
            const tbody = document.getElementById('itemsTableBody');
            if (tbody.children.length === 0) {
                for (let i = 0; i < 10; i++) {
                    addRow();
                }
            }
            
            // Setup auto-save listeners
            setupAutoSave();
        });
    </script>

    <script>
        // Global variables
        let allHistory = [];
        let priceDatabase = {};
        let specialNoteEnabled = false;
        let specialNoteText = '';
        let digitalSignatureEnabled = false;
        let directorSignature = '';
        let officerSignature = '';

        // Tab switching
        async function switchTab(tabName) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            if (tabName === 'admin') {
                const result = await Swal.fire({
                    title: 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
                    input: 'password',
                    inputPlaceholder: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
                    showCancelButton: true,
                    confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    confirmButtonColor: '#1a365d',
                    inputValidator: (value) => {
                        if (!value) {
                            return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'
                        }
                        if (value !== '0000') {
                            return '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'
                        }
                    }
                });

                if (!result.isConfirmed) {
                    return; // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ó‡πá‡∏ö
                }
            }

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'history') {
                loadHistory();
            }
        }

        // Add new row to table
        function addRow() {
            const tbody = document.getElementById('itemsTableBody');
            const rowCount = tbody.rows.length + 1;
            const row = tbody.insertRow();

            row.innerHTML = `
                <td class="number-col">${rowCount}</td>
                <td><input type="text" class="item-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ Paste ‡∏à‡∏≤‡∏Å Excel" /></td>
                <td><input type="number" class="price-input" step="0.01" min="0" placeholder="0.00" oninput="calculateTotal(this)" /></td>
                <td><input type="number" class="qty-input" step="0.01" min="0" placeholder="0" oninput="calculateTotal(this)" /></td>
                <td><input type="text" class="unit-input" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" /></td>
                <td class="total-col"><span class="row-total">0.00</span></td>
                <td class="action-col">
                    <button class="btn btn-icon" onclick="deleteRow(this)" style="background: #e53e3e; color: white;" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß">
                        üóëÔ∏è
                    </button>
                </td>
            `;

            // Add paste event listener
            const itemInput = row.querySelector('.item-input');
            itemInput.addEventListener('paste', handlePaste);
        }

        // Delete row
        function deleteRow(btn) {
            const row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateRowNumbers();
            calculateGrandTotal();
        }

        // Update row numbers
        function updateRowNumbers() {
            const tbody = document.getElementById('itemsTableBody');
            const rows = tbody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                rows[i].cells[0].textContent = i + 1;
            }
        }

        // Calculate row total
        function calculateTotal(input) {
            const row = input.parentNode.parentNode;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const total = price * qty;
            row.querySelector('.row-total').textContent = total.toFixed(2);
            calculateGrandTotal();
        }

        // Calculate grand total
        function calculateGrandTotal() {
            const tbody = document.getElementById('itemsTableBody');
            const rows = tbody.getElementsByTagName('tr');
            let grandTotal = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const totalText = rows[i].querySelector('.row-total').textContent;
                grandTotal += parseFloat(totalText) || 0;
            }
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        // Enhanced paste handler
        function handlePaste(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text');
            let rows = pastedData.split('\n')
                .map(row => row.trim())
                .filter(row => row !== ''); // ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
            
            if (rows.length === 0) return;

            const tbody = document.getElementById('itemsTableBody');
            const allRows = tbody.getElementsByTagName('tr');
            
            // ‡∏´‡∏≤ row ‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á
            let startRowIndex = -1;
            for (let i = 0; i < allRows.length; i++) {
                const row = allRows[i];
                const isEmpty = !row.querySelector('.item-input').value &&
                               !row.querySelector('.price-input').value &&
                               !row.querySelector('.qty-input').value &&
                               !row.querySelector('.unit-input').value;
                if (isEmpty) {
                    startRowIndex = i;
                    break;
                }
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ row ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° row ‡πÉ‡∏´‡∏°‡πà
            if (startRowIndex === -1) {
                addRow();
                startRowIndex = allRows.length - 1;
            }

            rows.forEach((rowData, index) => {
                let cells = rowData.split('\t').map(cell => cell.trim());
                
                // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 5+ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å)
                if (cells.length > 4) {
                    cells = cells.slice(0, 4);
                }
                
                let targetRow;
                const targetIndex = startRowIndex + index;
                
                // ‡∏ñ‡πâ‡∏≤ row ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                if (targetIndex >= allRows.length) {
                    addRow();
                    targetRow = tbody.rows[tbody.rows.length - 1];
                } else {
                    targetRow = allRows[targetIndex];
                }

                // Fill in the data
                if (cells[0]) targetRow.querySelector('.item-input').value = cells[0];
                if (cells[1]) targetRow.querySelector('.price-input').value = cells[1];
                if (cells[2]) targetRow.querySelector('.qty-input').value = cells[2];
                if (cells[3]) targetRow.querySelector('.unit-input').value = cells[3];

                // Calculate total for this row
                const priceInput = targetRow.querySelector('.price-input');
                if (priceInput.value) {
                    calculateTotal(priceInput);
                }
            });

            updateRowNumbers();
        }

        // Clear table
        async function clearTable() {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#38a169',
                cancelButtonColor: '#e53e3e',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;
            
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                addRow();
            }
            
            calculateGrandTotal();
            
            Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Confirm clear draft
        async function confirmClearDraft() {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Draft',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á)',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e53e3e',
                cancelButtonColor: '#718096',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            // Clear form fields
            document.getElementById('semester').value = '';
            document.getElementById('projectName').value = '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏∑‡πà‡∏≠ ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢';
            document.getElementById('director').value = '';
            document.getElementById('officer').value = '';
            document.getElementById('docType').value = '‡∏ã‡∏∑‡πâ‡∏≠';
            document.getElementById('creatorName').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('department').selectedIndex = 0;

            // Clear table
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                addRow();
            }
            calculateGrandTotal();

            // Clear localStorage
            clearFormLocalStorage();

            await Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Draft ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Get form data
        function getFormData() {
            const data = {
                semester: document.getElementById('semester').value,
                projectName: document.getElementById('projectName').value,
                director: document.getElementById('director').value,
                officer: document.getElementById('officer').value,
                docType: document.getElementById('docType').value,
                creatorName: document.getElementById('creatorName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                department: document.getElementById('department').value,
                items: [],
                grandTotal: document.getElementById('grandTotal').textContent,
                specialNoteEnabled: false,  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
                specialNote: ''
            };

            const tbody = document.getElementById('itemsTableBody');
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const item = rows[i].querySelector('.item-input').value;
                const price = rows[i].querySelector('.price-input').value;
                const qty = rows[i].querySelector('.qty-input').value;
                const unit = rows[i].querySelector('.unit-input').value;
                const total = rows[i].querySelector('.row-total').textContent;

                if (item || price || qty || unit) {
                    data.items.push({
                        no: i + 1,
                        item: item,
                        price: price,
                        quantity: qty,
                        unit: unit,
                        total: total
                    });
                }
            }

            return data;
        }

        // Validate form
        function validateForm() {
            const semester = document.getElementById('semester').value;
            const projectName = document.getElementById('projectName').value;
            const creatorName = document.getElementById('creatorName').value;
            const department = document.getElementById('department').value;

            if (!semester) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return false;
            }

            if (!projectName) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return false;
            }

            if (!creatorName) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return false;
            }

            const phoneNumber = document.getElementById('phoneNumber').value;
            if (!phoneNumber) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return false;
            }

            if (!department) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return false;
            }

            const data = getFormData();
            if (data.items.length === 0) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return false;
            }

            return true;
        }

        // Save data to Firebase
        async function saveData() {
            if (!validateForm()) return;

            try {
                showLoading(true);
                const data = getFormData();
                data.createdAt = new Date().toISOString();

                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'purchase-orders'),
                    data
                );

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                for (const item of data.items) {
                    if (item.item && item.price) {
                        const key = item.item.toLowerCase().trim();
                        if (!priceDatabase[key] || parseFloat(item.price) !== parseFloat(priceDatabase[key].price)) {
                            priceDatabase[key] = {
                                item: item.item,
                                price: item.price,
                                unit: item.unit,
                                lastUpdated: new Date().toISOString()
                            };
                        }
                    }
                }
                await savePriceDatabase();

                await Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                
                // Clear form and localStorage
                clearTable();
                clearFormLocalStorage();
                document.getElementById('semester').value = '';
                document.getElementById('projectName').value = '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏∑‡πà‡∏≠ ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢';
                document.getElementById('creatorName').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('department').selectedIndex = 0;

                // Switch to history tab
                await loadHistory();
                switchTab('history');

            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
            } finally {
                showLoading(false);
            }
        }

        // ===== AUTO-SAVE TO LOCAL STORAGE =====
        
        // Save form to localStorage
        function saveFormToLocalStorage() {
            try {
                const formData = {
                    semester: document.getElementById('semester').value,
                    projectName: document.getElementById('projectName').value,
                    director: document.getElementById('director').value,
                    officer: document.getElementById('officer').value,
                    docType: document.getElementById('docType').value,
                    creatorName: document.getElementById('creatorName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    department: document.getElementById('department').value,
                    items: []
                };

                // Save items from table
                const tbody = document.getElementById('itemsTableBody');
                const rows = tbody.getElementsByTagName('tr');
                
                for (let row of rows) {
                    const item = row.querySelector('.item-input').value.trim();
                    const price = row.querySelector('.price-input').value.trim();
                    const quantity = row.querySelector('.qty-input').value.trim();
                    const unit = row.querySelector('.unit-input').value.trim();
                    
                    // Save only non-empty rows
                    if (item || price || quantity || unit) {
                        formData.items.push({ item, price, quantity, unit });
                    }
                }

                localStorage.setItem('purchaseOrderDraft', JSON.stringify(formData));
                
                // Update last saved time indicator
                const now = new Date();
                const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('autoSaveIndicator').textContent = `üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${timeString}`;
                document.getElementById('autoSaveIndicator').style.opacity = '1';
                
                // Fade out after 2 seconds
                setTimeout(() => {
                    document.getElementById('autoSaveIndicator').style.opacity = '0';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // Load form from localStorage
        function loadFormFromLocalStorage() {
            try {
                const saved = localStorage.getItem('purchaseOrderDraft');
                if (!saved) return;

                const formData = JSON.parse(saved);
                
                // Load form fields
                document.getElementById('semester').value = formData.semester || '';
                document.getElementById('projectName').value = formData.projectName || '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏∑‡πà‡∏≠ ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏à‡∏±‡∏¢';
                document.getElementById('director').value = formData.director || '';
                document.getElementById('officer').value = formData.officer || '';
                document.getElementById('docType').value = formData.docType || '‡∏ã‡∏∑‡πâ‡∏≠';
                document.getElementById('creatorName').value = formData.creatorName || '';
                document.getElementById('phoneNumber').value = formData.phoneNumber || '';
                document.getElementById('department').value = formData.department || '';

                // Load items
                if (formData.items && formData.items.length > 0) {
                    const tbody = document.getElementById('itemsTableBody');
                    tbody.innerHTML = '';

                    formData.items.forEach((item, index) => {
                        addRow();
                        const row = tbody.rows[index];
                        if (row) {
                            row.querySelector('.item-input').value = item.item || '';
                            row.querySelector('.price-input').value = item.price || '';
                            row.querySelector('.qty-input').value = item.quantity || '';
                            row.querySelector('.unit-input').value = item.unit || '';
                            
                            const priceInput = row.querySelector('.price-input');
                            if (priceInput.value) {
                                calculateTotal(priceInput);
                            }
                        }
                    });

                    // Add extra empty rows
                    for (let i = 0; i < 5; i++) {
                        addRow();
                    }
                } else {
                    // Initialize with 10 empty rows
                    for (let i = 0; i < 10; i++) {
                        addRow();
                    }
                }

                updateRowNumbers();
                calculateGrandTotal();

                // Show notification
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });

                Toast.fire({
                    icon: 'info',
                    title: 'üìã ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß'
                });

            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        // Clear form localStorage
        function clearFormLocalStorage() {
            try {
                localStorage.removeItem('purchaseOrderDraft');
                document.getElementById('autoSaveIndicator').textContent = '';
                document.getElementById('autoSaveIndicator').style.opacity = '0';
            } catch (error) {
                console.error('Error clearing localStorage:', error);
            }
        }

        // Setup auto-save listeners
        function setupAutoSave() {
            // Save on input change
            const formInputs = [
                'semester', 'projectName', 'director', 'officer', 
                'docType', 'creatorName', 'phoneNumber', 'department'
            ];

            formInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debounce(saveFormToLocalStorage, 1000));
                    element.addEventListener('change', saveFormToLocalStorage);
                }
            });

            // Save when table changes (use event delegation)
            document.getElementById('itemsTableBody').addEventListener('input', 
                debounce(saveFormToLocalStorage, 1000)
            );
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Format Thai date
        function formatThaiDate(date = new Date()) {
            const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                               '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            if (typeof date === 'string') date = new Date(date);
            const day = date.getDate();
            const month = thaiMonths[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        // Convert number to Thai text
        function numberToThaiText(number) {
            const units = ['', '‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏™‡∏≠‡∏á', '‡∏™‡∏≤‡∏°', '‡∏™‡∏µ‡πà', '‡∏´‡πâ‡∏≤', '‡∏´‡∏Å', '‡πÄ‡∏à‡πá‡∏î', '‡πÅ‡∏õ‡∏î', '‡πÄ‡∏Å‡πâ‡∏≤'];
            const places = ['', '‡∏™‡∏¥‡∏ö', '‡∏£‡πâ‡∏≠‡∏¢', '‡∏û‡∏±‡∏ô', '‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏™‡∏ô', '‡∏•‡πâ‡∏≤‡∏ô'];
            
            if (number === 0) return '‡∏®‡∏π‡∏ô‡∏¢‡πå';
            
            let result = '';
            let numStr = Math.floor(number).toString();
            
            for (let i = 0; i < numStr.length; i++) {
                const digit = parseInt(numStr[i]);
                const place = numStr.length - i - 1;
                
                if (digit === 0) continue;
                
                if (place === 1 && digit === 2) {
                    result += '‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö';
                } else if (place === 1 && digit === 1) {
                    result += '‡∏™‡∏¥‡∏ö';
                } else if (place === 0 && digit === 1 && numStr.length > 1) {
                    result += '‡πÄ‡∏≠‡πá‡∏î';
                } else {
                    result += units[digit] + places[place];
                }
            }
            
            return result + '‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô';
        }

        // Generate document HTML
        function generateDocumentHTML(type, data = null, isMerged = false, mergedData = null) {
            if (!data) data = getFormData();
            
            const date = formatThaiDate();
            const totalText = numberToThaiText(parseFloat(data.grandTotal));
            const docTypeText = data.docType === '‡∏ã‡∏∑‡πâ‡∏≠' ? '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏-‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : '‡∏à‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';

            if (type === 'detail') {
                let html = '';
                
                if (isMerged && mergedData) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                    mergedData.forEach((record, index) => {
                        html += generateSingleDetailDocument(record, index > 0);
                    });
                } else {
                    html = generateSingleDetailDocument(data, false);
                }
                
                return html;
            } else {
                let html = '';
                
                if (isMerged && mergedData) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                    mergedData.forEach((record, index) => {
                        html += generateSingleOrderDocument(record, index > 0);
                    });
                } else {
                    html = generateSingleOrderDocument(data, false);
                }
                
                return html;
            }
        }

        function generateSingleDetailDocument(data, pageBreak) {
            const showSpecialNote = data.specialNoteEnabled === true && data.specialNote;
            const fontSize = data.useSmallFont ? '11px' : '16px'; // ‡∏•‡∏î 30% ‡∏à‡∏≤‡∏Å 16px ‡πÄ‡∏õ‡πá‡∏ô 11px
            
            return `
                <div class="print-document" ${pageBreak ? 'style="page-break-before: always;"' : ''}>
                    <div class="doc-header">
                        <div class="doc-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                        <div class="doc-subtitle">${data.projectName}</div>
                        <div class="doc-subtitle">‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.</div>
                        <div class="doc-subtitle">${data.creatorName} ${data.department} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${data.grandTotal} ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30px;">‡∏ó‡∏µ‡πà</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th style="width: 85px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢<br>(‡∏ö‡∏≤‡∏ó)</th>
                                <th style="width: 60px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th style="width: 75px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                                <th style="width: 85px;">‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô<br>(‡∏ö‡∏≤‡∏ó)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.items.map(item => `
                                <tr>
                                    <td style="text-align: center;">${item.no}</td>
                                    <td style="text-align: left;">${item.item}</td>
                                    <td style="text-align: center;">${item.price || '-'}</td>
                                    <td style="text-align: center;">${item.quantity || '-'}</td>
                                    <td style="text-align: center;">${item.unit || '-'}</td>
                                    <td style="text-align: center;">${item.total}</td>
                                </tr>
                            `).join('')}
                            ${Array(Math.max(0, 19 - data.items.length)).fill().map(() => `
                                <tr>
                                    <td style="text-align: center;">&nbsp;</td>
                                    <td style="text-align: left;">&nbsp;</td>
                                    <td style="text-align: center;">&nbsp;</td>
                                    <td style="text-align: center;">&nbsp;</td>
                                    <td style="text-align: center;">&nbsp;</td>
                                    <td style="text-align: center;">&nbsp;</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="text-align: right;">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (${numberToThaiText(parseFloat(data.grandTotal))})</td>
                                <td style="text-align: center;">${data.grandTotal}</td>
                            </tr>
                        </tfoot>
                    </table>
                    <div style="margin-top: 40px; text-align: center;">
                        <div style="margin-bottom: 5px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ...........................................</div>
                        <div>(${data.creatorName})</div>
                        <div>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    </div>
                    ${showSpecialNote ? `<div style="text-align: center; margin-top: 20px; font-size: ${fontSize}; color: #0066cc; font-weight: 500; line-height: 1.6;">${data.specialNote}</div>` : ''}
                </div>
            `;
        }

        function generateSingleOrderDocument(data, pageBreak) {
            const date = '.............. ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô .......................................... ‡∏û.‡∏®. ...............';
            const docTypeText = data.docType === '‡∏ã‡∏∑‡πâ‡∏≠' ? '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏-‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : '‡∏à‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
            const showSpecialNote = data.specialNoteEnabled === true && data.specialNote;
            const fontSize = data.useSmallFont ? '11px' : '16px'; // ‡∏•‡∏î 30% ‡∏à‡∏≤‡∏Å 16px ‡πÄ‡∏õ‡πá‡∏ô 11px
            
            return `
                <div class="print-document" ${pageBreak ? 'style="page-break-before: always;"' : ''}>
                    <div class="doc-header" style="text-align: center; margin-bottom: 10px;">
                        <div class="doc-title">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á${data.docType}‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                    <div class="doc-header-right" style="text-align: right; margin-bottom: 15px;">
                        <div class="doc-subtitle">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
                        <div class="doc-subtitle">102 ‡∏´‡∏°‡∏π‡πà 2 ‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á</div>
                        <div class="doc-subtitle">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©</div>
                    </div>
                    <div class="doc-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}</div>
                    <div class="doc-content">
                        <p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô .........................................................................................</p>
                        <p style="text-indent: 30px;">‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ ${data.director} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏£‡∏°‡∏¢‡πå ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á${docTypeText}</p>
                        <p>‡πÉ‡∏ô${data.projectName} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ ‡∏î‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th style="width: 100px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô(‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</th>
                                <th style="width: 90px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.items.map(item => `
                                <tr>
                                    <td style="text-align: center;">${item.no}</td>
                                    <td style="text-align: left;">${item.item}</td>
                                    <td style="text-align: center;">${item.quantity || '-'}</td>
                                    <td style="text-align: center;">${item.unit || '-'}</td>
                                </tr>
                            `).join('')}
                            ${Array(Math.max(0, 15 - data.items.length)).fill().map(() => `
                                <tr>
                                    <td style="text-align: center;">&nbsp;</td>
                                    <td style="text-align: left;">&nbsp;</td>
                                    <td style="text-align: center;">&nbsp;</td>
                                    <td style="text-align: center;">&nbsp;</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="note">
                        <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ : ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${data.grandTotal} ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    <div class="signature-section">
                        <div class="signature-box">
                            ${digitalSignatureEnabled && officerSignature ? `
                                <img src="${officerSignature}" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà" />
                            ` : `
                                <div class="signature-line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠............................................</div>
                            `}
                            <div>(${data.officer})</div>
                            <div>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
                        </div>
                        <div class="signature-box">
                            ${digitalSignatureEnabled && directorSignature ? `
                                <img src="${directorSignature}" alt="‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£" />
                            ` : `
                                <div class="signature-line">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠............................................</div>
                            `}
                            <div>(${data.director})</div>
                            <div>‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
                        </div>
                    </div>
                    ${showSpecialNote ? `<div style="text-align: center; margin-top: 20px; font-size: ${fontSize}; color: #0066cc; font-weight: 500; line-height: 1.6;">${data.specialNote}</div>` : ''}
                </div>
            `;
        }

        // Preview document
        function previewDocument(type) {
            if (!validateForm()) return;

            const html = generateDocumentHTML(type);
            document.getElementById('previewArea').innerHTML = html;
            document.getElementById('printArea').innerHTML = html;
            
            const modalTitle = type === 'detail' ? '‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì' : '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á';
            document.getElementById('modalTitle').textContent = 'üìÑ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á' + modalTitle;
            
            document.getElementById('previewModal').classList.add('active');
        }

        // Load history
        async function loadHistory() {
            try {
                showLoading(true);

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'purchase-orders'),
                    window.firestore.orderBy('createdAt', 'desc')
                );

                const querySnapshot = await window.firestore.getDocs(q);
                allHistory = [];

                querySnapshot.forEach((doc) => {
                    allHistory.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Populate filter dropdowns
                const semesters = [...new Set(allHistory.map(h => h.semester))];
                const filterSemester = document.getElementById('filterSemester');
                filterSemester.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                semesters.forEach(sem => {
                    filterSemester.innerHTML += `<option value="${sem}">${sem}</option>`;
                });

                displayHistory(allHistory);

            } catch (error) {
                console.error('Error loading history:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error'
                });
            } finally {
                showLoading(false);
            }
        }

        // Display history
        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #718096; padding: 3rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                return;
            }

            historyList.innerHTML = history.map(record => {
                const date = formatThaiDate(record.createdAt);
                const hasSpecialNote = record.specialNoteEnabled === true;
                const noteText = hasSpecialNote ? (record.specialNote || '') : '';
                
                return `
                    <div class="history-card">
                        <div class="history-card-header">
                            <div style="flex: 1;">
                                <div class="history-card-title">${record.projectName}</div>
                                <div class="history-card-meta">${date} | ${record.creatorName}</div>
                                ${hasSpecialNote ? `
                                    <div class="special-note-display">${noteText}</div>
                                ` : ''}
                            </div>
                            <div class="history-card-badge">${record.docType === '‡∏ã‡∏∑‡πâ‡∏≠' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á'}</div>
                        </div>
                        <div class="history-card-info">
                            <div><strong>‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${record.semester}</div>
                            <div><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞:</strong> ${record.department}</div>
                            <div><strong>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${record.grandTotal} ‡∏ö‡∏≤‡∏ó</div>
                            <div><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> ${record.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        </div>
                        <div class="history-card-actions">
                            <input type="checkbox" class="merge-checkbox-item" data-id="${record.id}" data-department="${record.department}">
                            <label style="margin-right: 1rem; font-size: 0.85rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ß‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå</label>
                            <button class="btn ${hasSpecialNote ? 'btn-success' : 'btn-warning'} btn-small" 
                                    onclick="toggleSpecialNoteForRecord('${record.id}')"
                                    title="${hasSpecialNote ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©'}">
                                ${hasSpecialNote ? 'üìù ‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà' : 'üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏ô‡πâ‡∏ï'}
                            </button>
                            <button class="btn btn-warning btn-small" onclick="loadHistoryToEdit('${record.id}')">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-primary btn-small" onclick="viewHistory('${record.id}', 'detail')">
                                üëÅÔ∏è ‡∏î‡∏π‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                            <button class="btn btn-primary btn-small" onclick="viewHistory('${record.id}', 'order')">
                                üëÅÔ∏è ‡∏î‡∏π‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏à‡πâ‡∏≤‡∏á
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteHistory('${record.id}')">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle special note for specific record
        async function toggleSpecialNoteForRecord(recordId) {
            try {
                const record = allHistory.find(h => h.id === recordId);
                if (!record) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                }

                const currentlyEnabled = record.specialNoteEnabled === true;

                if (currentlyEnabled) {
                    // ‡∏°‡∏µ‡πÇ‡∏ô‡πâ‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î
                    const { value: action } = await Swal.fire({
                        title: 'üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                        html: `
                            <div style="text-align: left;">
                                <p style="margin-bottom: 1rem;">‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</p>
                                <div style="padding: 0.75rem; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 4px; margin-bottom: 1rem;">
                                    ${record.specialNote}
                                </div>
                                <p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?</p>
                            </div>
                        `,
                        icon: 'question',
                        showCancelButton: true,
                        showDenyButton: true,
                        confirmButtonColor: '#38a169',
                        denyButtonColor: '#e53e3e',
                        cancelButtonColor: '#718096',
                        confirmButtonText: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                        denyButtonText: 'üóëÔ∏è ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    });

                    if (action === true) {
                        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ô‡πâ‡∏ï
                        const { value: newNote, isConfirmed } = await Swal.fire({
                            title: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                            html: `
                                <div style="text-align: left;">
                                    <p style="margin-bottom: 1rem;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</p>
                                    <textarea id="swal-note-input" class="swal2-input" rows="3" style="width: 100%; height: auto;">${record.specialNote}</textarea>
                                </div>
                            `,
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonColor: '#38a169',
                            cancelButtonColor: '#718096',
                            confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                            preConfirm: () => {
                                const noteInput = document.getElementById('swal-note-input');
                                return noteInput.value;
                            }
                        });

                        if (!isConfirmed || !newNote) {
                            return;
                        }

                        showLoading(true);

                        // Update Firebase
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'purchase-orders', recordId),
                            {
                                specialNote: newNote
                            }
                        );

                        showLoading(false);

                        await Swal.fire({
                            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });

                    } else if (action === false) {
                        // ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï
                        showLoading(true);

                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'purchase-orders', recordId),
                            {
                                specialNoteEnabled: false,
                                specialNote: ''
                            }
                        );

                        showLoading(false);

                        await Swal.fire({
                            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: '‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        return;
                    }

                } else {
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á template
                    const creatorName = record.creatorName || '';
                    const phoneNumber = record.phoneNumber || '';

                    if (!creatorName || !phoneNumber) {
                        await Swal.fire({
                            title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                            html: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>- ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå<br>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏î‡πâ',
                            icon: 'warning',
                            confirmButtonColor: '#1a365d'
                        });
                        return;
                    }

                    const template = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà -${creatorName} ‡πÇ‡∏ó‡∏£.${phoneNumber}`;

                    const { value: customNote, isConfirmed } = await Swal.fire({
                        title: 'üìù ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©',
                        html: `
                            <div style="text-align: left;">
                                <p style="margin-bottom: 1rem;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</p>
                                <textarea id="swal-note-input" class="swal2-input" rows="3" style="width: 100%; height: auto;">${template}</textarea>
                                <p style="margin-top: 1rem; font-size: 0.85rem; color: #718096;">
                                    üí° ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                                </p>
                            </div>
                        `,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#38a169',
                        cancelButtonColor: '#718096',
                        confirmButtonText: '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                        preConfirm: () => {
                            const noteInput = document.getElementById('swal-note-input');
                            return noteInput.value;
                        }
                    });

                    if (!isConfirmed || !customNote) {
                        return;
                    }

                    showLoading(true);

                    // Update Firebase
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'purchase-orders', recordId),
                        {
                            specialNoteEnabled: true,
                            specialNote: customNote
                        }
                    );

                    showLoading(false);

                    await Swal.fire({
                        title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }

                // Reload history to show changes
                await loadHistory();

            } catch (error) {
                console.error('‚ùå Error toggling special note:', error);
                showLoading(false);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏î‡πâ<br><br>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
            }
        }

        // Filter history
        function filterHistory() {
            const semester = document.getElementById('filterSemester').value;
            const department = document.getElementById('filterDepartment').value;
            const docType = document.getElementById('filterDocType').value;

            let filtered = allHistory;

            if (semester) {
                filtered = filtered.filter(h => h.semester === semester);
            }

            if (department) {
                filtered = filtered.filter(h => h.department === department);
            }

            if (docType) {
                filtered = filtered.filter(h => h.docType === docType);
            }

            displayHistory(filtered);
        }

        // View history
        async function viewHistory(id, type) {
            try {
                const record = allHistory.find(h => h.id === id);
                if (!record) {
                    Swal.fire({
                        title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ',
                        icon: 'error'
                    });
                    return;
                }

                const html = generateDocumentHTML(type, record);
                document.getElementById('previewArea').innerHTML = html;
                document.getElementById('printArea').innerHTML = html;
                
                const modalTitle = type === 'detail' ? '‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì' : '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠/‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á';
                document.getElementById('modalTitle').textContent = 'üìÑ ' + modalTitle;
                
                document.getElementById('previewModal').classList.add('active');
            } catch (error) {
                console.error('Error viewing history:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // Load history to edit
        async function loadHistoryToEdit(id) {
            try {
                const record = allHistory.find(h => h.id === id);
                if (!record) {
                    Swal.fire({
                        title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ',
                        icon: 'error'
                    });
                    return;
                }

                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById('createTab').classList.add('active');
                document.querySelector('.tab[onclick*="create"]').classList.add('active');

                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('semester').value = record.semester || '';
                document.getElementById('projectName').value = record.projectName || '';
                document.getElementById('director').value = record.director || '';
                document.getElementById('officer').value = record.officer || '';
                document.getElementById('docType').value = record.docType || '‡∏ã‡∏∑‡πâ‡∏≠';
                document.getElementById('creatorName').value = record.creatorName || '';
                document.getElementById('phoneNumber').value = record.phoneNumber || '';
                document.getElementById('department').value = record.department || '';

                // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°
                const tbody = document.getElementById('itemsTableBody');
                tbody.innerHTML = '';

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                record.items.forEach((item, index) => {
                    addRow();
                    const row = tbody.rows[index];
                    if (row) {
                        row.querySelector('.item-input').value = item.item || '';
                        row.querySelector('.price-input').value = item.price || '';
                        row.querySelector('.qty-input').value = item.quantity || '';
                        row.querySelector('.unit-input').value = item.unit || '';
                        
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
                        const priceInput = row.querySelector('.price-input');
                        if (priceInput.value) {
                            calculateTotal(priceInput);
                        }
                    }
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° row ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î
                for (let i = 0; i < 5; i++) {
                    addRow();
                }

                updateRowNumbers();
                calculateGrandTotal();

                // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Firebase
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'purchase-orders', id));

                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                await Swal.fire({
                    title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

                // Scroll ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading history to edit:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // Delete history
        async function deleteHistory(id) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e53e3e',
                cancelButtonColor: '#718096',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            try {
                showLoading(true);
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'purchase-orders', id));
                
                await Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                
                await loadHistory();
            } catch (error) {
                console.error('Error deleting:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error'
                });
            } finally {
                showLoading(false);
            }
        }

        // Print merged documents
        async function printMergedDocuments(type) {
            const checkboxes = document.querySelectorAll('.merge-checkbox-item:checked');
            
            if (checkboxes.length === 0) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.id);
            const mergedData = allHistory.filter(h => selectedIds.includes(h.id));

            const html = generateDocumentHTML(type, null, true, mergedData);
            document.getElementById('printArea').innerHTML = html;
            
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Print merged single table (‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        async function printMergedSingleTable(type) {
            const checkboxes = document.querySelectorAll('.merge-checkbox-item:checked');
            
            if (checkboxes.length === 0) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.id);
            const mergedData = allHistory.filter(h => selectedIds.includes(h.id));

            // ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const allItems = [];
            let itemCounter = 1;
            let totalBudget = 0;

            mergedData.forEach(record => {
                record.items.forEach(item => {
                    allItems.push({
                        no: itemCounter++,
                        item: item.item,
                        price: item.price,
                        quantity: item.quantity,
                        unit: item.unit,
                        total: item.total
                    });
                    totalBudget += parseFloat(item.total) || 0;
                });
            });

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            const specialNotes = [];
            mergedData.forEach(record => {
                if (record.specialNoteEnabled === true && record.creatorName && record.phoneNumber) {
                    specialNotes.push({
                        name: record.creatorName,
                        phone: record.phoneNumber
                    });
                }
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏£‡∏ß‡∏°
            let combinedSpecialNote = '';
            let useSmallFont = false;
            
            if (specialNotes.length > 0) {
                // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ (‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
                const uniqueNotes = specialNotes.filter((note, index, self) =>
                    index === self.findIndex(n => n.name === note.name && n.phone === note.phone)
                );
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                if (uniqueNotes.length === 1) {
                    combinedSpecialNote = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà -${uniqueNotes[0].name} ‡πÇ‡∏ó‡∏£.${uniqueNotes[0].phone}`;
                } else {
                    const noteLines = uniqueNotes.map(note => 
                        `-${note.name} ‡πÇ‡∏ó‡∏£.${note.phone}`
                    ).join('<br>');
                    combinedSpecialNote = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà<br>${noteLines}`;
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2 ‡∏Ñ‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ font ‡πÄ‡∏•‡πá‡∏Å
                    if (uniqueNotes.length > 2) {
                        useSmallFont = true;
                    }
                }
            }

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            if (mergedData.length > 1) {
                const firstRecord = mergedData[0];
                const hasNote = combinedSpecialNote !== '';
                
                const result = await Swal.fire({
                    title: 'üìÑ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏°',
                    html: `
                        <div style="text-align: left;">
                            <p style="margin-bottom: 1rem;">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>${mergedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                            <div style="padding: 1rem; background: #f7fafc; border-left: 3px solid #1a365d; border-radius: 4px; margin-bottom: 1rem;">
                                <p style="margin: 0; font-weight: 600; margin-bottom: 0.5rem; color: #1a365d;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å:</p>
                                <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; line-height: 1.8;">
                                    <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> ${firstRecord.projectName}</li>
                                    <li><strong>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> ${firstRecord.creatorName}</li>
                                    <li><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞:</strong> ${firstRecord.department}</li>
                                    ${hasNote ? `<li><strong>‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©:</strong> ‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>` : '<li><strong>‡πÇ‡∏ô‡πâ‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏©:</strong> <em style="color: #718096;">‡πÑ‡∏°‡πà‡∏°‡∏µ</em></li>'}
                                </ul>
                            </div>
                            <p style="font-size: 0.9rem; color: #718096; margin: 0;">
                                <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${allItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                            </p>
                        </div>
                    `,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#38a169',
                    cancelButtonColor: '#718096',
                    confirmButtonText: '‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    width: '600px'
                });

                if (!result.isConfirmed) {
                    return;
                }
            }

            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const firstRecord = mergedData[0];
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á combined data ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
            const combinedData = {
                projectName: firstRecord.projectName,
                department: firstRecord.department,
                director: firstRecord.director,
                officer: firstRecord.officer,
                docType: firstRecord.docType,
                creatorName: firstRecord.creatorName,
                phoneNumber: firstRecord.phoneNumber || '',
                items: allItems,
                grandTotal: totalBudget.toFixed(2),
                // ‡πÉ‡∏ä‡πâ‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß
                specialNoteEnabled: combinedSpecialNote !== '',
                specialNote: combinedSpecialNote,
                useSmallFont: useSmallFont  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ font ‡πÄ‡∏•‡πá‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            };

            const html = type === 'detail' ? 
                generateSingleDetailDocument(combinedData, false) : 
                generateSingleOrderDocument(combinedData, false);

            document.getElementById('printArea').innerHTML = html;
            
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Export all data to Excel
        async function exportAllData() {
            try {
                showLoading(true);

                if (allHistory.length === 0) {
                    await loadHistory();
                }

                const exportData = [];
                allHistory.forEach(record => {
                    record.items.forEach(item => {
                        exportData.push({
                            '‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': record.semester,
                            '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': record.projectName,
                            '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞': record.department,
                            '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': record.docType === '‡∏ã‡∏∑‡πâ‡∏≠' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏à‡πâ‡∏≤‡∏á',
                            '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item.item,
                            '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.price,
                            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': item.quantity,
                            '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö': item.unit,
                            '‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô': item.total,
                            '‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': record.creatorName,
                            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å': formatThaiDate(record.createdAt)
                        });
                    });
                });

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
                
                const fileName = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠-‡∏à‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                await Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error exporting:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error'
                });
            } finally {
                showLoading(false);
            }
        }

        // Import price database
        async function importPriceDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showLoading(true);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        const newPriceDatabase = {};
                        let importCount = 0;
                        
                        rows.slice(1).forEach(row => {
                            if (row[0]) {
                                const key = row[0].toLowerCase().trim();
                                newPriceDatabase[key] = {
                                    item: row[0],
                                    price: row[1] || '',
                                    unit: row[2] || '',
                                    lastUpdated: new Date().toISOString()
                                };
                                importCount++;
                            }
                        });

                        priceDatabase = newPriceDatabase;
                        
                        // Save to Firebase
                        await savePriceDatabase();
                        
                        await Swal.fire({
                            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            html: `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${importCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
                            icon: 'success',
                            confirmButtonColor: '#1a365d'
                        });
                        
                        showLoading(false);
                    } catch (error) {
                        console.error('‚ùå Error processing Excel file:', error);
                        showLoading(false);
                        
                        Swal.fire({
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                            html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ<br><br>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`,
                            icon: 'error',
                            confirmButtonColor: '#1a365d'
                        });
                    }
                };
                
                reader.onerror = (error) => {
                    console.error('‚ùå Error reading file:', error);
                    showLoading(false);
                    
                    Swal.fire({
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ',
                        icon: 'error',
                        confirmButtonColor: '#1a365d'
                    });
                };
                
                reader.readAsArrayBuffer(file);

            } catch (error) {
                console.error('‚ùå Error importing:', error);
                showLoading(false);
                
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ<br><br>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
            } finally {
                event.target.value = '';
            }
        }

        // Save price database
        async function savePriceDatabase() {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                }

                console.log('üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤...', {
                    itemCount: Object.keys(priceDatabase).length,
                    sample: Object.keys(priceDatabase).slice(0, 3)
                });

                const docRef = window.firestore.doc(window.db, 'settings', 'price-database');
                
                await window.firestore.setDoc(
                    docRef,
                    { data: priceDatabase, lastUpdated: new Date().toISOString() }
                );

                console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const verifyDoc = await window.firestore.getDoc(docRef);
                if (verifyDoc.exists()) {
                    const savedData = verifyDoc.data();
                    console.log('‚úîÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô: ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase', {
                        itemCount: Object.keys(savedData.data || {}).length,
                        lastUpdated: savedData.lastUpdated
                    });
                } else {
                    console.error('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!');
                    throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Firebase');
                }

            } catch (error) {
                console.error('‚ùå Error saving price database:', error);
                throw error; // Re-throw error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            }
        }

        // Load price database
        async function loadPriceDatabase() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    priceDatabase = {};
                    return;
                }

                console.log('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Firebase...');

                const docRef = window.firestore.doc(window.db, 'settings', 'price-database');
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    priceDatabase = loadedData.data || {};
                    console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, {
                        itemCount: Object.keys(priceDatabase).length,
                        lastUpdated: loadedData.lastUpdated,
                        sample: Object.keys(priceDatabase).slice(0, 3)
                    });
                } else {
                    priceDatabase = {};
                    console.log('üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤ - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà');
                }
            } catch (error) {
                console.error('‚ùå Error loading price database:', error);
                priceDatabase = {};
                throw error; // Re-throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            }
        }

        // Show price database
        async function showPriceDatabase() {
            try {
                showLoading(true);

                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Firebase ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á
                await loadPriceDatabase();

                const items = Object.values(priceDatabase).sort((a, b) => 
                    a.item.localeCompare(b.item, 'th')
                );

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ filter ‡πÑ‡∏î‡πâ
                window.allPriceItems = items;

                if (items.length === 0) {
                    document.getElementById('priceDbContent').innerHTML = '<p style="text-align: center; color: #718096; padding: 2rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤</p>';
                } else {
                    renderPriceDatabase(items);
                }

                // Clear search box
                document.getElementById('priceDbSearch').value = '';
                document.getElementById('priceDbModal').classList.add('active');

                showLoading(false);
            } catch (error) {
                console.error('‚ùå Error loading price database:', error);
                showLoading(false);
                
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ<br><br>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
            }
        }

        // Render price database table
        function renderPriceDatabase(items) {
            document.getElementById('priceDbContent').innerHTML = `
                <div style="margin-bottom: 0.5rem; color: #718096;">
                    ‡πÅ‡∏™‡∏î‡∏á ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>
                <table class="price-history-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th style="width: 120px;">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                            <th style="width: 100px;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                            <th style="width: 100px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => {
                            const key = item.item.toLowerCase().trim();
                            return `
                            <tr>
                                <td style="text-align: center;">${index + 1}</td>
                                <td>${item.item}</td>
                                <td style="text-align: right;">${item.price}</td>
                                <td>${item.unit}</td>
                                <td style="text-align: center;">
                                    <button class="btn-icon-small btn-icon-edit" onclick="editPriceItem('${key.replace(/'/g, "\\'")}')">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn-icon-small btn-icon-delete" onclick="deletePriceItem('${key.replace(/'/g, "\\'")}')">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        // Filter price database
        function filterPriceDatabase() {
            const searchText = document.getElementById('priceDbSearch').value.toLowerCase().trim();
            
            if (!window.allPriceItems) return;

            if (searchText === '') {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                renderPriceDatabase(window.allPriceItems);
            } else {
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                const filtered = window.allPriceItems.filter(item => 
                    item.item.toLowerCase().includes(searchText) ||
                    item.price.toString().includes(searchText) ||
                    item.unit.toLowerCase().includes(searchText)
                );
                renderPriceDatabase(filtered);
            }
        }

        // Edit price item
        function editPriceItem(key) {
            const item = priceDatabase[key];
            if (!item) {
                Swal.fire({
                    title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ',
                    icon: 'error'
                });
                return;
            }

            // Update modal title
            document.getElementById('editItemModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';

            // Set values in edit modal
            document.getElementById('editItemKey').value = key;
            document.getElementById('editItemName').value = item.item;
            document.getElementById('editItemPrice').value = item.price;
            document.getElementById('editItemUnit').value = item.unit;

            // Show modal
            document.getElementById('editItemModal').classList.add('active');
        }

        // Add new price item
        function addNewPriceItem() {
            // Update modal title
            document.getElementById('editItemModalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';

            // Clear form
            document.getElementById('editItemKey').value = '';
            document.getElementById('editItemName').value = '';
            document.getElementById('editItemPrice').value = '';
            document.getElementById('editItemUnit').value = '';

            // Show modal
            document.getElementById('editItemModal').classList.add('active');
        }

        // Save edited item
        async function saveEditedItem() {
            const oldKey = document.getElementById('editItemKey').value;
            const newName = document.getElementById('editItemName').value.trim();
            const newPrice = document.getElementById('editItemPrice').value.trim();
            const newUnit = document.getElementById('editItemUnit').value.trim();

            console.log('üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:', {
                oldKey: oldKey,
                newName: newName,
                newPrice: newPrice,
                newUnit: newUnit
            });

            if (!newName || !newPrice || !newUnit) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return;
            }

            try {
                showLoading(true);

                const newKey = newName.toLowerCase().trim();

                console.log('üîÑ ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:', {
                    totalItems: Object.keys(priceDatabase).length,
                    hasOldKey: oldKey in priceDatabase,
                    oldData: priceDatabase[oldKey]
                });

                // If name changed, delete old key
                if (oldKey !== newKey && oldKey !== '') {
                    delete priceDatabase[oldKey];
                    console.log('üóëÔ∏è ‡∏•‡∏ö key ‡πÄ‡∏Å‡πà‡∏≤:', oldKey);
                }

                // Update or create new entry
                priceDatabase[newKey] = {
                    item: newName,
                    price: newPrice,
                    unit: newUnit,
                    lastUpdated: new Date().toISOString()
                };

                console.log('‚úèÔ∏è ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:', {
                    totalItems: Object.keys(priceDatabase).length,
                    newKey: newKey,
                    newData: priceDatabase[newKey]
                });

                // Save to Firebase
                console.log('üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase...');
                await savePriceDatabase();
                console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

                // Refresh display
                const items = Object.values(priceDatabase).sort((a, b) => 
                    a.item.localeCompare(b.item, 'th')
                );
                window.allPriceItems = items;
                renderPriceDatabase(items);

                closeModal('editItemModal');

                await Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('‚ùå Error saving edited item:', error);
                
                // ‡∏ñ‡πâ‡∏≤ save ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ rollback ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                console.log('üîô ‡∏Å‡∏≥‡∏•‡∏±‡∏á rollback...');
                await loadPriceDatabase();
                
                const items = Object.values(priceDatabase).sort((a, b) => 
                    a.item.localeCompare(b.item, 'th')
                );
                window.allPriceItems = items;
                renderPriceDatabase(items);

                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ<br><br>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Console (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°`,
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
            } finally {
                showLoading(false);
            }
        }

        // Delete price item
        async function deletePriceItem(key) {
            const item = priceDatabase[key];
            if (!item) return;

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                html: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br><strong>"${item.item}"</strong><br>‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e53e3e',
                cancelButtonColor: '#718096',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            try {
                showLoading(true);

                delete priceDatabase[key];
                
                // Save to Firebase
                await savePriceDatabase();

                // Refresh display
                const items = Object.values(priceDatabase).sort((a, b) => 
                    a.item.localeCompare(b.item, 'th')
                );
                window.allPriceItems = items;

                // Re-filter if search is active
                const searchText = document.getElementById('priceDbSearch').value.toLowerCase().trim();
                if (searchText) {
                    const filtered = items.filter(item => 
                        item.item.toLowerCase().includes(searchText) ||
                        item.price.toString().includes(searchText) ||
                        item.unit.toLowerCase().includes(searchText)
                    );
                    renderPriceDatabase(filtered);
                } else {
                    renderPriceDatabase(items);
                }

                await Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('‚ùå Error deleting item:', error);
                
                // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ rollback
                await loadPriceDatabase();
                
                const items = Object.values(priceDatabase).sort((a, b) => 
                    a.item.localeCompare(b.item, 'th')
                );
                window.allPriceItems = items;
                renderPriceDatabase(items);

                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    html: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ<br><br>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
            } finally {
                showLoading(false);
            }
        }

        // Show price history
        function showPriceHistory() {
            const priceHistory = {};
            
            allHistory.forEach(record => {
                record.items.forEach(item => {
                    if (item.item && item.price) {
                        const key = item.item;
                        if (!priceHistory[key]) {
                            priceHistory[key] = [];
                        }
                        priceHistory[key].push({
                            price: item.price,
                            unit: item.unit,
                            date: record.createdAt,
                            project: record.projectName,
                            department: record.department
                        });
                    }
                });
            });

            let html = '<div style="background: white; padding: 2rem;">';
            html += '<h3 style="margin-bottom: 1.5rem;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>';

            Object.keys(priceHistory).sort().forEach(itemName => {
                const history = priceHistory[itemName].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );

                html += `
                    <div style="margin-bottom: 2rem; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">${itemName}</h4>
                        <table class="price-history-table">
                            <thead>
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                                    <th>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                                    <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${history.map(h => `
                                    <tr>
                                        <td>${formatThaiDate(h.date)}</td>
                                        <td style="text-align: right;">${h.price} ‡∏ö‡∏≤‡∏ó</td>
                                        <td>${h.unit}</td>
                                        <td>${h.project}</td>
                                        <td>${h.department}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('priceHistoryArea').innerHTML = html;
            document.getElementById('priceHistoryModal').classList.add('active');
        }

        // Print price history
        function printPriceHistory() {
            const content = document.getElementById('priceHistoryArea').innerHTML;
            document.getElementById('printArea').innerHTML = content;
            
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Toggle special note
        function toggleSpecialNote() {
            specialNoteEnabled = document.getElementById('specialNoteToggle').checked;
            document.getElementById('specialNoteInput').style.display = specialNoteEnabled ? 'block' : 'none';
            document.getElementById('specialNoteStatus').textContent = specialNoteEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            
            saveAdminSettings();
        }

        // Use default special note template
        function useDefaultSpecialNote() {
            const creatorName = document.getElementById('creatorName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!creatorName || !phoneNumber) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å<br>- ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå<br>‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ template',
                    icon: 'warning',
                    confirmButtonColor: '#1a365d'
                });
                return;
            }
            
            const template = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà -${creatorName} ‡πÇ‡∏ó‡∏£.${phoneNumber}`;
            document.getElementById('specialNoteText').value = template;
            
            Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡πÉ‡∏™‡πà template ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        async function saveSpecialNote() {
            specialNoteText = document.getElementById('specialNoteText').value;
            await saveAdminSettings();
            
            await Swal.fire({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // ===== DIGITAL SIGNATURE FUNCTIONS =====

        // Toggle digital signature
        function toggleDigitalSignature() {
            digitalSignatureEnabled = document.getElementById('digitalSignatureToggle').checked;
            document.getElementById('digitalSignatureInputs').style.display = digitalSignatureEnabled ? 'block' : 'none';
            document.getElementById('digitalSignatureStatus').textContent = digitalSignatureEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            
            saveAdminSettings();
        }

        // Upload signature
        async function uploadSignature(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file type
            if (file.type !== 'image/png') {
                Swal.fire({
                    title: '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
                event.target.value = '';
                return;
            }

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                Swal.fire({
                    title: '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB',
                    icon: 'error',
                    confirmButtonColor: '#1a365d'
                });
                event.target.value = '';
                return;
            }

            try {
                showLoading(true);

                // Convert to base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;

                    if (type === 'director') {
                        directorSignature = base64;
                        updateSignaturePreview('director', base64);
                    } else if (type === 'officer') {
                        officerSignature = base64;
                        updateSignaturePreview('officer', base64);
                    }

                    await saveAdminSettings();

                    await Swal.fire({
                        title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    showLoading(false);
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Error uploading signature:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error'
                });
                showLoading(false);
            } finally {
                event.target.value = '';
            }
        }

        // Update signature preview
        function updateSignaturePreview(type, base64) {
            const previewId = type === 'director' ? 'directorSignaturePreview' : 'officerSignaturePreview';
            const preview = document.getElementById(previewId);
            
            if (base64) {
                preview.innerHTML = `<img src="${base64}" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô" />`;
            } else {
                preview.innerHTML = '<div class="signature-preview-empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>';
            }
        }

        // Delete signature
        async function deleteSignature(type) {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                text: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e53e3e',
                cancelButtonColor: '#718096',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            try {
                showLoading(true);

                if (type === 'director') {
                    directorSignature = '';
                    updateSignaturePreview('director', '');
                } else if (type === 'officer') {
                    officerSignature = '';
                    updateSignaturePreview('officer', '');
                }

                await saveAdminSettings();

                await Swal.fire({
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('Error deleting signature:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏î‡πâ: ' + error.message,
                    icon: 'error'
                });
            } finally {
                showLoading(false);
            }
        }

        // Save admin settings
        async function saveAdminSettings() {
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                }

                await window.firestore.setDoc(
                    window.firestore.doc(window.db, 'settings', 'admin'),
                    {
                        specialNoteEnabled: specialNoteEnabled,
                        specialNoteText: specialNoteText,
                        digitalSignatureEnabled: digitalSignatureEnabled,
                        directorSignature: directorSignature,
                        officerSignature: officerSignature
                    },
                    { merge: true }
                );
                
                console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (error) {
                console.error('‚ùå Error saving admin settings:', error);
                throw error;
            }
        }

        // Load admin settings
        async function loadAdminSettings() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                await loadPriceDatabase();
                
                if (!window.db || !window.firestore) {
                    console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° - ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                    return;
                }
                
                const docRef = window.firestore.doc(window.db, 'settings', 'admin');
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Special note
                    specialNoteEnabled = data.specialNoteEnabled || false;
                    specialNoteText = data.specialNoteText || '';
                    document.getElementById('specialNoteToggle').checked = specialNoteEnabled;
                    document.getElementById('specialNoteText').value = specialNoteText;
                    document.getElementById('specialNoteInput').style.display = specialNoteEnabled ? 'block' : 'none';
                    document.getElementById('specialNoteStatus').textContent = specialNoteEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';

                    // Digital signature
                    digitalSignatureEnabled = data.digitalSignatureEnabled || false;
                    directorSignature = data.directorSignature || '';
                    officerSignature = data.officerSignature || '';
                    
                    document.getElementById('digitalSignatureToggle').checked = digitalSignatureEnabled;
                    document.getElementById('digitalSignatureInputs').style.display = digitalSignatureEnabled ? 'block' : 'none';
                    document.getElementById('digitalSignatureStatus').textContent = digitalSignatureEnabled ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    
                    // Update previews
                    updateSignaturePreview('director', directorSignature);
                    updateSignaturePreview('officer', officerSignature);
                    
                    console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    console.log('üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                }
            } catch (error) {
                console.error('‚ùå Error loading admin settings:', error);
                // ‡πÑ‡∏°‡πà throw error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            }
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Print document
        function printDocument() {
            closeModal('previewModal');
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Show loading
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        // Show toast
        function showToast(message, type = 'success') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'bottom-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });

            Toast.fire({
                icon: type === 'error' ? 'error' : 'success',
                title: message
            });
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });
    </script>
</body>
</html>
